# szkub

Bitrix-проект: код в Git, локальная разработка в Docker (env-docker), прод обновляется из GitHub.

## Структура
- `docs/` — исходная верстка
- `local/templates/szcube/` — шаблон Bitrix (css/js/img/fonts + header/footer)
- `index.php` — главная
- `consulting/` — страница консалтинга

## Примечания
- Бандла нет, все скрипты — отдельные файлы.

## Локальная разработка (env-docker)
env-docker лежит рядом: `/home/sxtim/dev/env-docker`, сайт доступен на `http://127.0.0.1:8588/`.

Запуск/остановка:
```bash
cd /home/sxtim/dev/env-docker
docker compose up -d        # старт
docker compose stop         # стоп
docker compose down         # стоп + удалить контейнеры (тома не трогает)
docker compose logs -f nginx php
```

Восстановление из бэкапа делай без override (чтобы случайно не перетереть код из Git):
```bash
cd /home/sxtim/dev/env-docker
docker compose -f docker-compose.yml up -d
```
Дальше открывай `http://127.0.0.1:8588/restore.php` и восстанавливай архив.

### Новые страницы/папки в корне сайта
Сейчас в `docker-compose.override.yml` прокинуты не весь репозиторий, а только выбранные пути (`local/`, `apartments/`, `consulting/`, `tenders/`, `index.php`).

Если создал новую папку в корне сайта (например `newpage/`) и хочешь видеть её в локалке — добавь её в `/home/sxtim/dev/env-docker/docker-compose.override.yml` в секции `php.volumes` и `nginx.volumes`:
```yml
- ../szkub/newpage:/opt/www/newpage
```
И примени:
```bash
cd /home/sxtim/dev/env-docker
docker compose up -d
```

## Прод: деплой из Git
Прод обновляется без merge (предсказуемо) — трогаются только tracked файлы.

```bash
cd /home/c/cf144342/bitrix_d7dca/public_html
git fetch origin --prune
git reset --hard origin/main
git diff --name-status HEAD..origin/main - посмотреть, что изменится
```

Откат:
```bash
git reset --hard <commit>
```

## Флоу разработки фичи (акции/новости)
Цель: сначала быстро верстаем (PHP-статика), потом “натягиваем” на админку (инфоблоки/компоненты) без переделки верстки.

Текущая структура страниц (статика):
- `/news/` — список новостей (`news/index.php`)
- `/news/<code>/` — детальная (`news/detail.php`, код приходит через `urlrewrite.php`)
- `/promotions/` — список акций (`promotions/index.php`)
- `/promotions/<code>/` — детальная (`promotions/detail.php`)
- фильтр акций по ЖК: `/promotions/?zhk=kollekciya` (акции без ЖК в фильтре не показываем)

Рабочие шаги в этой ветке:
1) Создаём PHP-скелеты страниц (без дизайна/админки).
2) Вставляем верстку по блокам прямо в эти страницы (пока статично).
3) Когда верстка “устаканится” — переносим данные в админку и заменяем статические массивы на инфоблоки/компоненты (верстку не ломаем).

Локалка (env-docker): чтобы видеть новые папки `news/` и `promotions/`, добавь их в `/home/sxtim/dev/env-docker/docker-compose.override.yml` (и в `php.volumes`, и в `nginx.volumes`), затем `docker compose up -d`.

## Структура в админке (план): сначала ЖК, дальше расширяемая модель `ЖК → (литер/позиция) → подъезд → (этаж) → квартира`
Цель: сначала быстро посадить в админку именно `ЖК` (проекты), а затем без болезненного рефакторинга расширить до структуры квартир и шахматки.

Рекомендация (по‑битриксовому):
- ИБ `Проекты (ЖК)` — элементы = жилые комплексы (`kollekciya`, `vertical` и т.д.). Используем для страниц `/projects/<code>/` и для привязок (акции/новости/документы/ход строительства).
- ИБ `Квартиры` — элементы = квартиры, разделы = дерево структуры.
- Отдельные ИБ (не смешивать с квартирами): `Паркинги`, `Кладовые`, `Коммерция` (у них своя логика полей, фильтров и карточек).

### Этапность внедрения (важно)
1. `Этап 1` — выводим в админку только ИБ `Проекты (ЖК)` и подключаем `/projects/` + `/projects/<code>/`.
2. `Этап 2` — подключаем ИБ `Квартиры` и структуру разделов (`ЖК → (литер/позиция) → подъезд`, при необходимости сразу добавляем уровень `этаж`).
3. `Этап 3` — добавляем шахматку, фильтр квартир и (при необходимости) отдельную сущность этажей.

Пример дерева разделов в ИБ `Квартиры`:
```text
Квартиры (ИБ)
└── Коллекция (раздел, CODE=kollekciya)             ← 1-й уровень всегда ЖК
    ├── podezd-1 (раздел, CODE=podezd-1)            ← если без литеров
    │   └── (элементы: квартиры)
    └── podezd-2 (раздел, CODE=podezd-2)
        └── (элементы: квартиры)

Квартиры (ИБ)                                        ← вариант с будущим уровнем
└── Коллекция (раздел, CODE=kollekciya)
    └── liter-1 (раздел, CODE=liter-1)
        ├── podezd-1 (раздел, CODE=podezd-1)
        │   └── (элементы: квартиры)
        └── podezd-2 (раздел, CODE=podezd-2)
            └── (элементы: квартиры)
```

Вариант с этажом как уровнем дерева (если так удобнее в админке для шахматки):
```text
Квартиры (ИБ)
└── Коллекция (раздел, CODE=kollekciya)
    └── liter-1 (раздел, CODE=liter-1)              ← опционально
        └── podezd-1 (раздел, CODE=podezd-1)
            ├── floor-01 (раздел, CODE=floor-01)
            │   └── (элементы: квартиры)
            ├── floor-02 (раздел, CODE=floor-02)
            │   └── (элементы: квартиры)
            └── ...
```

### Этажи (для шахматки) — добавлять в дерево или нет?
Допустимы оба варианта:
- `без отдельного уровня этажа` — проще дерево, этаж хранится в поле/свойстве квартиры (`FLOOR`);
- `с уровнем этажа в дереве` — удобнее ручная работа в админке и навигация для шахматки.

Если приоритет — удобство контент-менеджера (ручное ведение структуры), можно и нужно использовать:
- `ЖК → (литер/позиция) → подъезд → этаж → квартира`

При этом всё равно рекомендуем хранить этаж и в поле/свойстве квартиры (`FLOOR`), чтобы:
- фильтр/сортировка не зависели от глубины дерева;
- проще было строить выборки и переносить данные;
- URL и бизнес-логика не зависели от структуры разделов.

Если позже у этажа появятся свои данные (план этажа, статус, схема, изображения), можно:
- использовать UF-поля раздела `этаж` (если этаж — уровень дерева);
- или вынести этажи в отдельную сущность (`ИБ`/`HL-блок`) — без ломки модели квартир.

URL квартир рекомендуем делать через ID (проще редиректы и переносы):
- сейчас: `/projects/kollekciya/podezd-1/flat-123/`
- потом (если появится литер/позиция): `/projects/kollekciya/liter-1/podezd-2/flat-123/`

Важно: уровни можно добавлять/убирать со временем. Чтобы “не ломать” структуру, фиксируем стабильные `CODE` для разделов (ЖК/литер/подъезд/этаж), а квартиры идентифицируем в URL по `ID` (`flat-123`).

Отдельно фиксируем архитектурное правило:
- у разных ЖК дерево может быть разной глубины (`ЖК → подъезд` или `ЖК → дом/литер → секция → подъезд → этаж`);
- новые уровни можно добавлять позже только в новых ЖК, не ломая старые;
- в коде нельзя жестко предполагать фиксированную глубину дерева (ориентируемся на `ID`/привязки и свойства элементов).

## Инфоблоки (план): Новости и Акции + будущие привязки
Заводим в админке ИБ `Новости` и ИБ `Акции` как самостоятельные сущности и сначала подключаем их на сайт через компоненты (без изменения вёрстки).

Привязки акций “на будущее” (чтобы не переделывать структуру позже):
- В ИБ `Акции` закладываем свойства (множественные):
  - `LINK_PROJECTS` — привязка к элементам ИБ `Проекты (ЖК)` (акция для одного/нескольких ЖК)
  - `LINK_FLATS` — привязка к элементам ИБ `Квартиры` (акция для одной/нескольких квартир)

Логику автоматического применения скидок (правила/приоритеты/пересечения) обсуждаем и внедряем отдельным этапом, когда станет понятен бизнес‑сценарий.

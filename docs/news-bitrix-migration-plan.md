# План перевода раздела "Новости" на Bitrix (через админку)

## Цель

Убрать хардкод новостей из боевого рендера (раньше это были `news/index.php`, `news/detail.php`, `local/templates/szcube/parts/news-data.php`) и перевести раздел на штатный `bitrix:news` с управлением контентом через админку Bitrix.

## Что согласовано

- Используем `bitrix:news` (комплексный компонент).
- Хлебные крошки переводим на штатный `bitrix:breadcrumb` (с кастомным шаблоном под текущую верстку).
- Детальный контент новости хранится в `DETAIL_TEXT` (HTML/WYSIWYG), выводится как HTML (без экранирования).
- Картинка пока одна и та же для списка и детали.
- Дата новости редактируется в админке (используем штатное поле `ACTIVE_FROM`).
- CTA ("Получить консультацию") в новостях не включаем.
- URL должны остаться как сейчас: `/news/` и `/news/#ELEMENT_CODE#/`.
- Разделы/рубрики пока не нужны.
- Пагинацию закладываем, фактически понадобится позже.

## Текущая ситуация (что есть сейчас)

- Исторически список новостей брался из PHP-массива (теперь источник миграции перенесен в `local/tools/data/news-hardcode-source.php`).
- Детальная страница ищет новость по `code` в том же массиве.
- Роутинг `/news/<code>/` сейчас ручной через `urlrewrite.php`.
- Контент деталки сейчас собран как массив блоков (`h3/p/ul/ol`) и рендерится вручную.
- `article-hero.php` уже умеет принимать `$articleHeroExtra` (можно переиспользовать в шаблоне `news.detail`).

## Целевая модель данных (инфоблок "Новости")

Используем стандартные поля инфоблока, без доп. свойств на первом этапе:

- `NAME` — заголовок новости
- `CODE` — символьный код (URL)
- `ACTIVE_FROM` — дата публикации (редактируется в админке)
- `PREVIEW_TEXT` — анонс для карточки
- `PREVIEW_PICTURE` — картинка (используется и в списке, и в детали)
- `DETAIL_TEXT` — HTML-контент детальной страницы (WYSIWYG)

Примечание: `DETAIL_PICTURE` пока не нужен, т.к. картинка одна и та же.

## Документация Bitrix (для сверки)

- `bitrix:news` (комплексный компонент): https://dev.1c-bitrix.ru/user_help/components/content/articles_and_news/news.php
- `bitrix:breadcrumb`: https://dev.1c-bitrix.ru/user_help/components/sluzhebnie/navigation/breadcrumb.php
- `CIBlockElement::Add` (импорт): https://dev.1c-bitrix.ru/api_help/iblock/classes/ciblockelement/add.php
- Инфоблок (создание/настройка): https://www.dev.1c-bitrix.ru/user_help/content/iblock/iblock_edit.php
- Элемент инфоблока (редактирование): https://www.dev.1c-bitrix.ru/user_help/content/iblock/iblock_element_edit.php

## Пошаговый план внедрения (с проверкой)

### Шаг 1. Зафиксировать схему данных и соответствие текущему хардкоду

Что делаем:

- Подтверждаем, что текущие данные из файла-источника миграции (`local/tools/data/news-hardcode-source.php`) перекладываются в стандартные поля инфоблока.
- Принимаем решение: `detail`-массив преобразуем в HTML и храним в `DETAIL_TEXT`.

Проверка:

- Для каждой текущей новости можно заполнить `NAME`, `CODE`, `ACTIVE_FROM`, `PREVIEW_TEXT`, `PREVIEW_PICTURE`, `DETAIL_TEXT`.

### Шаг 2. Подготовить `/news/` под `bitrix:news` (каркас страницы)

Что делаем:

- Переводим `news/index.php` на `bitrix:news` (`SEF_MODE=Y`).
- Сохраняем текущие флаги `NEWS_PAGE`, `FOOTER_FLAT`.
- Сохраняем обертки страницы (включая блок хлебных крошек).
- Настраиваем SEF:
  - `SEF_FOLDER` = `/news/`
  - `SEF_URL_TEMPLATES["news"]` = `""`
  - `SEF_URL_TEMPLATES["detail"]` = `"#ELEMENT_CODE#/"`

Проверка:

- URL схема совпадает с текущей (`/news/`, `/news/<code>/`).
- Страница не падает с PHP-ошибкой после подключения компонента.

### Шаг 3. Сделать шаблон списка `bitrix:news.list` под текущие карточки

Что делаем:

- Создаем шаблон `news.list` и переносим HTML карточек из текущего `news/index.php`.
- Выводим:
  - картинку из `PREVIEW_PICTURE`
  - дату из `ACTIVE_FROM` в формате `d.m.Y`
  - заголовок из `NAME`
  - анонс из `PREVIEW_TEXT`
- Добавляем `AddEditAction` / `AddDeleteAction` для редактирования с фронта.

Проверка:

- Верстка карточек визуально совпадает с текущей.
- У администратора/редактора видны иконки правки на карточках.

### Шаг 4. Сделать шаблон детали `bitrix:news.detail` под текущую деталку

Что делаем:

- Создаем шаблон `news.detail`.
- Переиспользуем `local/templates/szcube/parts/article-hero.php`.
- Формируем данные для hero:
  - `title` <- `NAME`
  - `text` <- `PREVIEW_TEXT` (как лид, при необходимости)
  - `image` <- `PREVIEW_PICTURE` (пока одна картинка)
  - `list` <- пусто
  - `CTA` <- `false`
- В `$articleHeroExtra` вставляем:
  - дату (`ACTIVE_FROM`)
  - блок `.news-detail__content` с `DETAIL_TEXT` (HTML, без экранирования)

Проверка:

- Деталь открывается по `ELEMENT_CODE`.
- HTML из редактора (`h3`, `p`, `ul`, `ol`) отображается корректно.
- Нет двойного экранирования HTML.

### Шаг 5. Перевести хлебные крошки на `bitrix:breadcrumb`

Что делаем:

- Заменяем использование кастомного `local/templates/szcube/parts/breadcrumbs.php` на `bitrix:breadcrumb`.
- Создаем шаблон `bitrix:breadcrumb` с текущей HTML-структурой (`breadcrumbs`, `breadcrumbs__list`, и т.д.).
- В `bitrix:news` включаем параметры цепочки:
  - `ADD_ELEMENT_CHAIN=Y`
  - `ADD_SECTIONS_CHAIN=N` (пока без разделов)
  - `INCLUDE_IBLOCK_INTO_CHAIN` — по необходимости (обычно `N`, если уже есть `/news/.section.php`)

Проверка:

- На `/news/` хлебные показывают `Новости`.
- На `/news/<code>/` хлебные показывают `Новости / <Название новости>`.
- Последний элемент хлебных не является ссылкой.

### Шаг 6. Создать инфоблок "Новости" в админке

Что делаем:

- Создаем новый инфоблок (без разделов).
- Привязываем к нужному сайту.
- Настраиваем символьные коды элементов.
- При необходимости задаем шаблон URL элемента (`/news/#ELEMENT_CODE#/`).

Проверка:

- Инфоблок виден в админке.
- Можно вручную создать тестовую новость.

### Шаг 7. Подготовить наполнение: вручную или импорт

Вариант A. Вручную (через админку)

- Заводим 1 тестовую новость вручную для проверки шаблонов.

Вариант B. Импорт (одноразовый скрипт)

- Готовим скрипт, который читает `local/tools/data/news-hardcode-source.php`.
- Скрипт создает/обновляет элементы по `CODE`.
- Скрипт переносит:
  - `code` -> `CODE`
  - `title` -> `NAME`
  - `date` -> `ACTIVE_FROM`
  - `preview` -> `PREVIEW_TEXT`
  - `image` -> `PREVIEW_PICTURE`
  - `detail` -> HTML в `DETAIL_TEXT`

Важно:

- Для `CIBlockElement::Add` дата должна передаваться в формате сайта (не обязательно `YYYY-MM-DD`).
- Скрипт лучше сделать идемпотентным (повторный запуск обновляет, а не дублирует).

Проверка:

- После ручного создания или импорта новости видны в списке.
- Деталь открывается по правильному URL.

### Шаг 8. QA и стабилизация

Что проверяем:

- `/news/` — список отображается
- `/news/<code>/` — деталь отображается
- `/news/not-exists/` — корректный 404
- хлебные крошки — корректная цепочка
- редактирование из админки
- редактирование "с экрана" (под админом)
- кеширование не мешает обновлениям (при необходимости чистим кеш)

Проверка:

- Все сценарии работают без зависимости от файлового хардкода новостей.

### Шаг 9. Уборка хардкода

Что делаем:

- Убираем использование файлового хардкода новостей из боевого пути.
- Оставляем файл временно как архив источника миграции или удаляем после подтверждения.
- Проверяем необходимость ручных правил в `urlrewrite.php` для `/news/` (если компонент/штатные правила полностью покрывают текущий маршрут).

Проверка:

- В кодовой базе раздел новостей работает от инфоблока.
- Хардкод новостей не участвует в рендеринге.

## Фаза подготовки (можно сделать до решения про импорт)

Эту часть можно реализовать сразу:

- Перевод `/news/` на `bitrix:news`
- Шаблоны `bitrix:news.list` и `bitrix:news.detail`
- Шаблон `bitrix:breadcrumb` под текущую верстку
- Подготовка скрипта импорта (без запуска)
- Чеклист ручного заведения новости в админке

## Что нельзя финально проверить до создания инфоблока

- Реальный вывод данных `bitrix:news`
- Детальная страница по `ELEMENT_CODE`
- Импорт (`CIBlockElement::Add`)
- Редактирование из админки/с фронта

## Короткий чеклист приемки

1. `/news/` показывает карточки из инфоблока.
2. `/news/<code>/` открывает детальную страницу по `CODE`.
3. Хлебные работают через `bitrix:breadcrumb`.
4. В хлебных детальной страницы есть название новости.
5. `DETAIL_TEXT` выводится как HTML.
6. Дата редактируется в админке и отображается на сайте.
7. Картинка используется в списке и детали.
8. Админ может редактировать новость из админки и с фронта.
9. Файл-источник миграции новостей не участвует в выводе.

## Следующий практический шаг (рекомендуемый)

Подготовить кодовую базу без завязки на реальные данные:

1. `news/index.php` -> `bitrix:news`
2. Шаблоны `bitrix:news.list` / `bitrix:news.detail`
3. Шаблон `bitrix:breadcrumb`
4. Черновик скрипта импорта (не запускать)

После этого можно отдельно решить:

- заводить первые новости вручную через админку
- или выполнить импорт из `local/tools/data/news-hardcode-source.php`
